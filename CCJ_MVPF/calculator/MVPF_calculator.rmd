```{r}
library(readr)
library(dplyr)
library(stringr)
library(glue)
```

```{r}
#DATA IMPORT

mvpf_inputs <- readxl::read_excel("/Users/larapesceares/CCJ/Data/CCJ_quantified_values.xlsx")
CPI_table <- readr::read_csv("/Users/larapesceares/CCJ/Data/CPI.csv") 
# CPI multipliers to convert to 2025$
```

```{r}
#FUNCTIONS

# pull a row by row_var
row_by <- function(var) {
  mvpf_inputs %>% filter(row_var == var) %>% slice(1)
}

# for row-var, get selected value and its source year (may be NA)
get_selected <- function(var) {
  r <- row_by(var)
  list(
    value = as.numeric(r$selected_value),
    year  = suppressWarnings(as.integer(r$source_dollar_year))
  )
}

# convert to 2025$ using CPI_table
to_2025 <- function(value, year) {
  if (is.na(year)) return(value)
  fac <- CPI_table$factor_to_2025[CPI_table$year == year]
  if (length(fac) == 0) stop(glue("No CPI factor for year {year} in CPI_table."), call. = FALSE)
  value * fac[1]
}

# return numeric 2025$ and a readable equation string
value_2025 <- function(var, digits = 2) {
  s   <- get_selected(var)
  v25 <- to_2025(s$value, s$year)
  eq  <- if (is.na(s$year)) {
    glue("{var}: {round(s$value,digits)} (assumed 2025$)")
  } else {
    fac <- CPI_table$factor_to_2025[CPI_table$year == s$year][1]
    glue("{var}: {round(s$value,digits)} × CPI[{s$year}]={round(fac,4)} = {round(v25,digits)} (2025$)")
  }
  list(v = v25, eq = eq)
}

# Sum rows, apply per-row sign from sheet, print equations
sum_rows <- function(vars, label = NULL, digits = 2) {
  vars <- as.character(vars)
  vars <- vars[!is.na(vars) & nzchar(vars)]
  if (length(vars) == 0) {
    if (!is.null(label)) cat(label, "components:\n  = 0 (2025$)\n\n")
    return(list(total = 0))
  }

  v_signed_vec <- numeric(length(vars))
  eq_lines <- character(length(vars))

  for (i in seq_along(vars)) {
    v <- vars[i]

    # base value + year
    sel <- get_selected(v)
    base_val <- as.numeric(sel$value)
    yr <- sel$year

    # CPI factor and unsigned 2025 value
    if (is.na(yr)) {
      fac <- NA_real_
      v25_unsigned <- base_val
    } else {
      fac <- CPI_table$factor_to_2025[CPI_table$year == yr][1]
      v25_unsigned <- to_2025(base_val, yr)
    }

    # sheet sign: "positive" / "negative"
    s_raw <- tolower(trimws(as.character(row_by(v)$sign)))
    sgn   <- if (s_raw == "negative") -1 else 1

    # signed values
    base_signed <- sgn * base_val
    v25_signed  <- sgn * v25_unsigned

    # store for summation
    v_signed_vec[i] <- v25_signed

    # build the signed equation line
    if (is.na(yr)) {
      eq_lines[i] <- glue("{v}: {round(base_signed, digits)} (assumed 2025$)")
    } else {
      eq_lines[i] <- glue("{v}: {round(base_signed, digits)} × CPI[{yr}]={round(fac, 4)} = {round(v25_signed, digits)} (2025$)")
    }
  }

  total <- sum(v_signed_vec, na.rm = TRUE)

  if (!is.null(label)) {
    cat(label, "components:\n")
    for (ln in eq_lines) cat("  ", ln, "\n", sep = "")
    cat("  = ", round(total, 2), " (2025$)\n\n", sep = "")
  }

  list(total = total)
}

# Default to x when values are NA
or_default <- function(x, default = 0) {
  if (is.null(x) || length(x) == 0 || is.na(x[1])) default else x
}


```

```{r}
# CALCULATOR INPUTS (Edit components to adjust)

# Detainee Value (row_var vectors)
LT_det_rows <- c("income_reduced")
ST_det_rows <- c("lost_wages", "wtp_freedom")

# Society Value (row_var vectors)
LT_soc_rows <- c("wrongful_death_wtp_life")
ST_soc_rows <- c("crime_prev_measure")

# Government Costs (row_var vectors)
LT_gov_rows <- c("inc_conv_len")
ST_gov_rows <- c("ccj_funding_2018")

# Ns (counts)
N_det <- or_default(value_2025("n_detainees")$v, 1)
N_soc <- or_default(value_2025("n_society")$v, 1)

```

```{r}
# CALCULATOR

# Sum each bucket (sheet-driven signs inside sum_rows)

# Detainee
LT_det <- sum_rows(LT_det_rows, label = "Long-term value to detainee")
ST_det <- sum_rows(ST_det_rows, label = "Short-term value to detainee")

# Society
LT_soc <- sum_rows(LT_soc_rows, label = "Long-term value to society")
ST_soc <- sum_rows(ST_soc_rows, label = "Short-term value to society")

# Gov
LT_gov <- sum_rows(LT_gov_rows, label = "Long-term cost to government")
ST_gov <- sum_rows(ST_gov_rows, label = "Short-term cost to government")

# Combine ST + LT within each population (per-person amounts; already signed by sheet)
det_per <- LT_det$total + ST_det$total
soc_per <- LT_soc$total + ST_soc$total

# Weight by Ns to convert to totals
det_total <- det_per * N_det
soc_total <- soc_per * N_det   # society benefits are per detainee right now

# Government total is annual; add LT + ST with no weights
gov_total <- LT_gov$total + ST_gov$total

# Build numerator/denominator totals (2025$)
numerator_total   <- soc_total + det_total
denominator_total <- gov_total

# MVPF
MVPF_total <- if (denominator_total == 0) NA_real_ else numerator_total / denominator_total

cat(glue("
Totals (2025$):
  Detainee total (ST+LT): {round(det_per,2)} × N_det={N_det} → {round(det_total,2)}
  Society total  (ST+LT): {round(soc_per,2)} × N_det={N_det} → {round(soc_total,2)}
  Government total (ST+LT): {round(gov_total,2)}

Numerator_total   = {round(numerator_total,2)}
Denominator_total = {round(denominator_total,2)}
MVPF_total        = {round(MVPF_total,4)}
"))

```